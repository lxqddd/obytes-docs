# ğŸ”— é“¾æ¥ï¼š
# æºæ–‡ä»¶ï¼šhttps://github.com/obytes/react-native-template-obytes/blob/master/.github/workflows/lint-ts.yml
# Starter å‘å¸ƒæµç¨‹ï¼šhttps://starter.obytes.com/ci-cd/app-releasing-process/

# âœï¸ æè¿°ï¼š
# æ­¤å·¥ä½œæµç”¨äºåˆ›å»ºåº”ç”¨çš„æ–°ç‰ˆæœ¬å¹¶æ¨é€æ–°æ ‡ç­¾åˆ°ä»“åº“ã€‚
# ç”±äºæ­¤å·¥ä½œæµä¼šå‘ä»“åº“æ¨é€ä»£ç ï¼Œæˆ‘ä»¬è®¾ç½® GitHub Bot ä½œä¸º Git ç”¨æˆ·ã€‚
# æ­¤å·¥ä½œæµéœ€è¦ä»ä»“åº“çš„ Actions é€‰é¡¹å¡æ‰‹åŠ¨è§¦å‘ã€‚
#         1. é€‰æ‹©æ‚¨çš„å‘å¸ƒç±»å‹ï¼ˆpatchã€minorã€majorï¼‰
#         2. å·¥ä½œæµå°†è¿è¡Œ np-release è„šæœ¬ï¼Œè¯¥è„šæœ¬æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
#             - ä½¿ç”¨ np æ ¹æ®å‘å¸ƒç±»å‹æå‡ package.json ä¸­çš„ç‰ˆæœ¬
#             - è¿è¡Œåº”ç”¨çš„é¢„æ„å»ºä»¥ä½¿ package.json ç‰ˆæœ¬ä¸åŸç”Ÿä»£ç ä¿æŒä¸€è‡´
#             - ä½¿ç”¨æ–°ç‰ˆæœ¬åˆ›å»ºæ–°æ ‡ç­¾
#             - å°†æ–°æ ‡ç­¾æ¨é€åˆ°ä»“åº“
#

# ğŸš¨ éœ€è¦ GITHUB å¯†é’¥ï¼š
#         - GH_TOKENï¼šå…·æœ‰ä»“åº“å†™å…¥æƒé™çš„ GitHub ä»¤ç‰Œã€‚
#           æ‚¨å¯ä»¥ä»æ­¤å¤„ç”Ÿæˆä¸€ä¸ªï¼šhttps://docs.github.com/en/enterprise-server@3.6/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens
#           ç¡®ä¿å°†å…¶æ·»åŠ åˆ°ä»“åº“å¯†é’¥ä¸­ï¼Œåç§°ä¸º GH_TOKEN

name: New App Version

on:
  workflow_dispatch:
    inputs:
      release-type:
        type: choice
        description: 'Release type (one of): patch, minor, major'
        required: true
        default: 'patch'
        options:
          - patch
          - minor
          - major

jobs:
  release:
    name: Create New Version and push new tag
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ” GH_TOKEN
        if: env.GH_TOKEN == ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: echo "GH_TOKEN=${GITHUB_TOKEN}" >> $GITHUB_ENV
      - name: ğŸ“¦ Checkout project repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: ğŸ“ Git User Setup
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: ğŸ“¦ Setup Node + PNPM + install deps
        uses: ./.github/actions/setup-node-pnpm-install

      - name: ğŸƒâ€â™‚ï¸ Run App release
        run: |
          pnpm app-release ${{ github.event.inputs.release-type }}
