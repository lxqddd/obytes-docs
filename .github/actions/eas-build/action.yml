# ğŸ”— é“¾æ¥ï¼š
# æºæ–‡ä»¶ï¼šhttps://github.com/obytes/react-native-template-obytes/blob/master/.github/actions/eas-build/action.yml
# EAS Build æ–‡æ¡£ï¼šhttps://docs.expo.dev/eas-update/github-actions/

# âœï¸ æè¿°ï¼š
# è¿™æ˜¯ä¸€ä¸ªå¤åˆåŠ¨ä½œï¼Œæ„å‘³ç€å®ƒå¯ä»¥åœ¨å…¶ä»–åŠ¨ä½œä¸­ä½¿ç”¨ã€‚
# æ­¤åŠ¨ä½œç”¨äºä¸ºç‰¹å®šç¯å¢ƒï¼ˆdevelopmentã€stagingã€productionï¼‰è§¦å‘ EAS Buildã€‚
# æ­¤åŠ¨ä½œæ¥å—ä»¥ä¸‹è¾“å…¥ï¼š
#        `APP_ENV`ï¼Œç”¨äºä¸ºç‰¹å®šç¯å¢ƒç”Ÿæˆ APKï¼ˆdevelopmentã€stagingã€productionï¼‰ã€‚é»˜è®¤ä½¿ç”¨ stagingã€‚
#        `AUTO_SUBMIT`ï¼Œé»˜è®¤ä¸º falseï¼Œå¦‚æœæ‚¨æƒ³è‡ªåŠ¨æäº¤æ„å»ºåˆ°å•†åº—ï¼Œè¯·è®¾ç½®ä¸º trueã€‚
#        `EXPO_TOKEN`ï¼Œå¿…éœ€ï¼Œæ‚¨çš„ Expo è´¦æˆ·çš„è®¿é—®ä»¤ç‰Œã€‚https://expo.dev/settings/access-tokens
#        `VERSION`ï¼Œå¿…éœ€ï¼Œè¦æ„å»ºçš„åº”ç”¨ç‰ˆæœ¬ã€‚ç”¨ä½œæ„å»ºæ¶ˆæ¯ã€‚
#        `ANDROID`ï¼Œé»˜è®¤ä¸º trueï¼Œå¦‚æœæ‚¨ä¸æƒ³ä¸º Android è§¦å‘æ„å»ºï¼Œè¯·è®¾ç½®ä¸º trueã€‚
#        `IOS`ï¼Œé»˜è®¤ä¸º falseï¼Œå¦‚æœæ‚¨æƒ³ä¸º iOS è§¦å‘æ„å»ºï¼Œè¯·è®¾ç½®ä¸º trueã€‚

# åœ¨è§¦å‘æ„å»ºä¹‹å‰ï¼Œæˆ‘ä»¬è¿è¡Œé¢„æ„å»ºè„šæœ¬æ¥åŸºäº APP_ENV ç”Ÿæˆå¿…è¦çš„åŸç”Ÿæ–‡ä»¶å¤¹ã€‚
# åŸºäº ANDROID å’Œ IOS è¾“å…¥ï¼Œæˆ‘ä»¬ä¸ºç›¸åº”å¹³å°è§¦å‘æ„å»ºå¹¶ä½¿ç”¨ç›¸åº”çš„æ ‡å¿—ã€‚

# ğŸ‘€ ä½¿ç”¨ç¤ºä¾‹ï¼š
#      - name: â±ï¸ EAS Build
#        uses: ./.github/actions/eas-build
#        with:
#          APP_ENV: staging
#          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
#          VERSION: ${{ github.event.release.tag_name }}
#          IOS: false

name: 'Setup EAS Build + Trigger Build'
description: 'Setup EAS Build + Trigger Build'
inputs:
  APP_ENV:
    description: 'APP_ENV (one of): development, staging, production'
    required: true
    default: 'staging'
  AUTO_SUBMIT: ## TODO: æˆ‘ä»¬ä¹Ÿéœ€è¦å¤„ç†è¿™ä¸ª
    description: 'AUTO_SUBMIT (one of): true, false'
    required: true
    default: 'false'
  ANDROID:
    description: 'run for ANDROID (one of): true, false'
    required: true
    default: 'true'
  VERSION:
    description: 'VERSION'
    required: true
    default: '0.0.0'
  IOS:
    description: 'run for IOS (one of): true, false'
    required: true
    default: 'false'
  EXPO_TOKEN:
    description: 'EXPO_TOKEN'
    required: true
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: ğŸ’¯ Check for EXPO_TOKEN
      run: |
        if [ -z "${{ inputs.EXPO_TOKEN }}" ]; then
          echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
          exit 1
        fi
      shell: bash

    - name: ğŸ“¦ Setup Expo and EAS
      uses: expo/expo-github-action@v8
      with:
        eas-version: latest
        token: ${{ inputs.EXPO_TOKEN }}

    - name: âš™ï¸ Run Prebuild
      run: pnpm prebuild:${{ inputs.APP_ENV }}
      shell: bash

    - name: ğŸ“± Run Android Build
      if: ${{ inputs.ANDROID == 'true' }}
      run: pnpm build:${{ inputs.APP_ENV }}:android --non-interactive  --no-wait --message "Build  ${{ inputs.APP_ENV }} ${{ inputs.VERSION }}"
      shell: bash

    - name: ğŸ“± Run IOS Build
      if: ${{ inputs.IOS == 'true' }}
      run: pnpm build:${{ inputs.APP_ENV }}:ios --non-interactive  --no-wait --message "Build ${{ inputs.APP_ENV }} ${{ inputs.VERSION }}"
      shell: bash
