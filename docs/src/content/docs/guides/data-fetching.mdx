---
title: 数据获取
description: 学习如何使用 react-query 和 axios 从服务器获取数据。
head:
  - tag: title
    content: 数据获取 | React Native / Expo Starter
---

import CodeBlock from '../../../components/code.astro';

从 React 开始，社区一直在构建丰富的工具和库生态系统来帮助您构建应用程序。其中最重要的部分之一是在应用程序中从服务器获取数据并显示它的能力。

虽然在 React 和 React Native 中有许多可用的数据获取选项，但社区最近倾向于采用 React Query 作为首选解决方案。这种趋势的原因是 React Query 开箱即用的简单性、灵活性和丰富的功能。

## 什么是 react-query？

[React-query](https://tanstack.com/query/v4/docs/overview) 是一个非常强大的库，它帮助您以非常简单的方式管理数据获取、缓存、无效化和甚至实现乐观 UI。

`react-query` 提供了钩子来简化在应用中获取和更新数据的过程。您可以使用预构建的钩子如 `useQuery` 和 `useMutation`，或者基于它们创建自己的自定义钩子。这使得开发者更容易管理数据并构建更高效的应用程序。

## 使用 react-query-kit 和 axios

由于入门模板旨在为您节省时间和精力，我们已经为您安装并配置了 react-query 和 Axios。

`src/api` 文件夹包含所有获取逻辑，其中 `common` 子文件夹包含专门为 `react-query` 设计的 `client`、`queryClient` 和几个实用函数。

由于我们使用 Axios 作为客户端，我们可以利用其所有高级功能，包括拦截器、请求取消等。有关 Axios 的更多信息，您可以在[这里](https://axios-http.com/)查看他们的网站。

为了使编写查询和变更更加容易，我们使用 [react-query-kit](https://github.com/liaoliao666/react-query-kit)，这是一个简单的工具包，可以使 ReactQuery 具有可重用性和类型安全性，并减少样板代码。

:::tip

我们建议您阅读以下指南并查看这些资源以了解更多关于 react-query 的信息：

- [React-query](https://tanstack.com/query/v4/docs/overview)
- [react-query-kit](https://github.com/liaoliao666/react-query-kit)
- [Practical React Query](https://tkdodo.eu/blog/practical-react-query)

:::

## 数据获取用例

假设您正在构建一个博客应用，需要添加以下功能：

- 显示所有帖子的 Feed 屏幕
- 显示单个帖子详细信息的 Post 屏幕
- 创建新帖子的屏幕

首先，在 `src/api` 中创建一个名为 `posts` 的新文件夹。这个文件夹将包含所有与帖子相关的逻辑。您可以将相同概念应用于应用程序中的其他实体，如用户。

### Feed 屏幕

Feed 屏幕将显示应用中所有可用的帖子。为此，我们需要创建一个名为 `usePosts` 的钩子，它将获取帖子并将它们显示为列表。

以下是创建 `usePosts` 钩子的步骤：

1. 在 `src/api/posts` 文件夹中，创建一个名为 `use-posts.ts` 的新文件。
2. 根据需要定义 `Response` 和 `Variables` 的类型，以确保您从服务器接收正确的数据。例如，您可以为帖子创建一个 `Post` 类型。
3. 使用 `react-query-kit` 库中的 `createQuery` 函数创建一个查询钩子，它将从服务器获取数据。我们将把它命名为 `usePosts` 钩子。

以下是 use-posts.ts 文件的完整代码：

<CodeBlock file="src/api/posts/use-posts.ts" />

`createQuery` 函数接受包含以下属性的对象：`queryKey`、`fetcher` 和 `options`。由于我们迁移到最新版本的 `react-query-kit`，`queryFn` 属性被 `fetcher` 替换，并且 `queryKey` 结构被简化。阅读更多关于 (createQuery)[https://github.com/liaoliao666/react-query-kit#createQuery] 的信息

:::tip
使用 `useq` 代码片段在 VSCode 中快速生成查询
![use-query](https://github.com/obytes/react-native-template-obytes/assets/114411010/c052a0ee-8fba-436a-950f-a0c7e44cf3ae)

:::

现在我们已经创建了自定义钩子，可以在应用中使用它来显示帖子列表。请按照以下步骤实现：

1. 在您的应用中创建一个新屏幕，并将其命名为 Posts。
2. 导入并使用我们之前创建的 usePosts 钩子来获取帖子列表。
3. 使用获取的数据显示帖子列表。

<CodeBlock file="src/app/(app)/index.tsx" />

如上面的代码所示，我们使用 `usePosts` 钩子来获取数据并处理加载状态。这允许我们在获取数据时显示加载指示器，然后在数据准备就绪后显示帖子列表。

在上面的示例中，如果请求失败，我们还会显示错误消息。

### Post 屏幕

Post 屏幕将显示单个帖子的详细信息。要获取和显示帖子，我们将创建一个名为 `usePost` 的新钩子。

我们可以使用之前创建 `usePosts` 钩子时使用的相同步骤。唯一的区别是我们将使用帖子的 `id` 作为变量来获取特定帖子。

以下是 `use-post.ts` 文件的完整代码：

<CodeBlock file="src/api/posts/use-post.ts" />

现在我们的钩子已经准备好在帖子详情屏幕中使用：

<CodeBlock file="src/app/feed/[id].tsx" />

### 添加新帖子

要添加新帖子，我们可以使用 `react-query-kit` 库中的 `createMutation` 函数。

以下是创建 useAddPost 钩子的步骤：

1. 在 `src/api/posts` 文件夹中创建一个名为 `use-add-post.ts` 的新文件。
2. 定义 `Variables` 和 `Response` 的类型，以确保您向服务器发送正确的数据。
3. 使用 `react-query-kit` 库中的 `createMutation` 函数创建一个变更钩子，它将数据发送到服务器。我们将这个钩子命名为 `useAddPost`。

以下是 `use-add-post.ts` 文件的完整代码：

<CodeBlock file="src/api/posts/use-add-post.ts" />

:::tip
使用 `usem` 代码片段在 VSCode 中快速生成变更

:::

现在我们的变更钩子已经准备好了。让我们创建一个名为 `AddPost` 的新屏幕，并使用 `useAddPost` 钩子中的数据来创建新帖子：

与我们在[表单部分](/ui-and-theme/forms)创建登录表单时所做的方式完全相同，我们将遵循相同的方法来创建一个用于创建新帖子的表单。

1. 使用 Zod 为新表单创建模式
2. 使用 react-hook-form 创建表单
3. 从 `useAddPost` 钩子获取 `mutate` 函数，并在表单提交时调用它
4. 您可以使用 `isPending` 状态在数据发送到服务器时显示加载指示器，然后在成功时将用户重定向到 Feed 屏幕。

<CodeBlock file="src/app/feed/add-post.tsx" />

## 使用 VS Code 代码片段创建 API 钩子

也许您注意到每次创建新的查询或变更钩子看起来都一样，您是对的。这就是为什么我们创建了一套 VS Code 代码片段来帮助您快速创建钩子。

- `useq`：创建新的查询钩子

![use-query](https://github.com/obytes/react-native-template-obytes/assets/114411010/c052a0ee-8fba-436a-950f-a0c7e44cf3ae)

- `useqv`：创建带有变量的新查询钩子

- `useiq`：创建新的无限查询钩子
- `usem`：创建新的变更钩子

![use-mutation](https://github.com/obytes/react-native-template-obytes/assets/11137944/c322f827-b71d-4629-a337-eb7cd96d4125)

## React Query 开发工具插件

为了管理和监控 `React Query` 实例，我们使用 [React Query 开发工具插件](https://docs.expo.dev/debugging/devtools-plugins/#react-query)，它为我们提供了对数据获取过程和缓存的实时可见性。
它提供了手动重新获取数据、检查和删除查询的能力，为我们的数据提供控制。
要使用它，在终端中按 `shift` + `m`，然后从打开的开发工具列表中选择 React Query 插件。插件的 Web 界面将打开并显示查询，使调试高效，就像下面的示例一样：

![React Query plugin web interface](https://github.com/obytes/react-native-template-obytes/assets/114411010/26bc96ef-e6cb-49c3-be3c-006d6901e440)
