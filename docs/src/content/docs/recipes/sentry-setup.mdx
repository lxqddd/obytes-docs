---
title: Sentry 设置
description: 如何在应用中设置 Sentry。
head:
  - tag: title
    content: Sentry 设置 | React Native / Expo Starter
---

import CodeBlock from '../../../components/code.astro';
import { Steps } from '@astrojs/starlight/components';

Sentry 是 JavaScript 生态系统中最受欢迎的错误报告解决方案之一，与 Expo 有着出色的集成，我们已经使用了一段时间，效果非常好。

入门套件并未预先配置 Sentry，但设置非常简单，本指南将引导您完成整个过程。

## 安装和配置 Sentry

<Steps>
1. 如果您还没有 Sentry 账户，请创建一个新的 [Sentry 账户](https://sentry.io/signup/)。登录后，为您的 React Native 应用创建一个新项目。

2. 在项目创建过程中，请密切注意并记录以下重要详细信息：

   - 组织标识符（Organization slug）
   - 项目名称
   - DSN

     我们将在下一步中使用这些详细信息在您的应用中配置 Sentry SDK。

3. 现在您还需要生成一个新的认证令牌，以便将其用于向 Sentry 上传源映射。要生成新的认证令牌，您需要前往开发者 [设置 > 认证令牌](https://sentry.io/settings/auth-tokens/) 并创建一个新令牌。

   - 复制并安全存储生成的令牌。您将需要此令牌来配置源映射上传。

4. 此时，您应该拥有以下需要添加到 `.env` 文件的环境变量：

   ```bash
   SENTRY_ORG=your_sentry_organization_slug
   SENTRY_PROJECT=your_sentry_project_name
   SENTRY_DSN=your_sentry_dsn
   ```

   :::note
   您可以为所有应用变体（开发、预发布、生产）使用相同的 Sentry 配置，因为 Sentry 允许您在仪表板中按应用 ID 或包名称过滤错误。这简化了设置和管理，同时仍能区分不同的环境。
   :::

   将这些变量添加到 `env.js` 中进行验证至关重要。`SENTRY_ORG` 和 `SENTRY_PROJECT` 应作为构建时变量添加，而 `SENTRY_DSN` 应作为客户端变量添加。

   按如下方式更新您的 `env.js` 文件：

   ```js title='env.js'
   // ... existing imports and configurations

   const client = z.object({
     // ... other client env vars
     SENTRY_DSN: z.string().min(1, 'SENTRY_DSN is required'),
   });

   const buildTime = z.object({
     // ... other build-time env vars
     SENTRY_ORG: z.string().min(1, 'SENTRY_ORG is required'),
     SENTRY_PROJECT: z.string().min(1, 'SENTRY_PROJECT is required'),
   });

   const _clientEnv = {
     // ... other client env vars
     SENTRY_DSN: process.env.SENTRY_DSN,
   };

   const _buildTimeEnv = {
     // ... other build-time env vars
     SENTRY_ORG: process.env.SENTRY_ORG,
     SENTRY_PROJECT: process.env.SENTRY_PROJECT,
   };

   // ... rest of the file
   ```

   :::note
   `SENTRY_AUTH_TOKEN` 不应添加到 `.env` 文件中，因为它是敏感信息，不应暴露或推送到版本控制中。相反，应使用 [Expo 仪表板](https://expo.dev/accounts/[account]/projects/[project]/secrets) 或 EAS CLI 将其作为 EAS 密钥添加：

   ```bash
   eas secret:create --scope your-project-name --name SENTRY_AUTH_TOKEN --value your-token-value --type string
   ```

   这确保了您的 Sentry 认证令牌保持安全，同时在构建过程中仍可访问。
   :::

5. 现在您可以在项目中安装 Sentry SDK。

   ```bash
   npx expo install @sentry/react-native
   ```

6. 将 Sentry 插件配置添加到您的 `app.config.ts` 文件中。

   ```tsx title='app.config.ts'
   // rest of the file

   import { ClientEnv, Env } from './env';

   export default ({ config }: ConfigContext): ExpoConfig => ({
     ...config,
     // rest of the config

     plugins: [
       // rest of the plugins
       [
         '@sentry/react-native/expo',
         {
           url: 'https://sentry.io/',
           organization: Env.SENTRY_ORG,
           project: Env.SENTRY_PROJECT,
           note: '确保将 SENTRY_AUTH_TOKEN 设置为环境变量以向 Sentry 进行身份验证。请勿将其添加到 .env 文件中。相反，为安全起见，请将其作为 EAS 密钥或 CI/CD 管道中的环境变量添加。',
           // 如果您使用自托管实例，请更新 url 属性的值
           // 以指向您的自托管实例。例如，https://self-hosted.example.com/。
         },
       ],
     ],
   });
   ```

7. 更新您的 Metro 配置以将调试 ID 注入源映射

   ```js title='metro.config.js'
   /* eslint-env node */
   // this replaces `const { getDefaultConfig } = require('expo/metro-config');`
   const { getSentryExpoConfig } = require('@sentry/react-native/metro');
   const { withNativeWind } = require('nativewind/metro');

   const config = getSentryExpoConfig(__dirname);

   module.exports = withNativeWind(config, { input: './global.css' });
   ```

8. 现在您已准备好在应用中初始化 Sentry。
   创建一个新文件 `src/lib/sentry.ts` 并添加以下代码：

   ```tsx title='src/lib/sentry.ts'
   import { Env } from '@env';
   import * as Sentry from '@sentry/react-native';
   import { useNavigationContainerRef } from 'expo-router';
   import { useEffect } from 'react';

   const navigationIntegration = Sentry.reactNavigationIntegration({
     enableTimeToInitialDisplay: true,
   });

   export const initSentry = () => {
     if (!__DEV__) {
       Sentry.init({
         dsn: Env.SENTRY_DSN,
         integrations: [navigationIntegration],
       });
     }
   };

   export const useSentryNavigationConfig = () => {
     const navigationRef = useNavigationContainerRef();

     useEffect(() => {
       if (navigationRef && !__DEV__) {
         navigationIntegration.registerNavigationContainer(navigationRef);
       }
     }, [navigationRef]);
   };
   ```

   然后，在您的 `src/app/_layout.tsx` 文件中初始化 Sentry 并配置导航：

   ```tsx title='src/app/_layout.tsx'
   import { initSentry, useSentryNavigationConfig } from '@/lib/sentry';
   import * as Sentry from '@sentry/react-native';

   initSentry();

   function RootLayout() {
     useSentryNavigationConfig();

     return (
       <Providers>
         <Stack>
           <Stack.Screen name="(app)" options={{ headerShown: false }} />
           <Stack.Screen name="onboarding" options={{ headerShown: false }} />
           ...
         </Stack>
       </Providers>
     );
   }

   // 使用 Sentry 包装您的应用
   export default Sentry.wrap(RootLayout);
   ```

   此设置将在您的应用中启用 Sentry 错误跟踪和性能监控。

9. 最后一件事情是添加 Apple 隐私清单，以防止与 Apple 相关的任何问题。
   创建一个新文件 `apple-privacy-manifest.json` 并添加以下代码：

   ```json title='apple-privacy-manifest.json'
   {
     "NSPrivacyCollectedDataTypes": [
       {
         "NSPrivacyCollectedDataType": "NSPrivacyCollectedDataTypeCrashData",
         "NSPrivacyCollectedDataTypeLinked": false,
         "NSPrivacyCollectedDataTypeTracking": false,
         "NSPrivacyCollectedDataTypePurposes": [
           "NSPrivacyCollectedDataTypePurposeAppFunctionality"
         ]
       },
       {
         "NSPrivacyCollectedDataType": "NSPrivacyCollectedDataTypePerformanceData",
         "NSPrivacyCollectedDataTypeLinked": false,
         "NSPrivacyCollectedDataTypeTracking": false,
         "NSPrivacyCollectedDataTypePurposes": [
           "NSPrivacyCollectedDataTypePurposeAppFunctionality"
         ]
       },
       {
         "NSPrivacyCollectedDataType": "NSPrivacyCollectedDataTypeOtherDiagnosticData",
         "NSPrivacyCollectedDataTypeLinked": false,
         "NSPrivacyCollectedDataTypeTracking": false,
         "NSPrivacyCollectedDataTypePurposes": [
           "NSPrivacyCollectedDataTypePurposeAppFunctionality"
         ]
       }
     ],
     "NSPrivacyAccessedAPITypes": [
       {
         "NSPrivacyAccessedAPIType": "NSPrivacyAccessedAPICategoryUserDefaults",
         "NSPrivacyAccessedAPITypeReasons": ["CA92.1"]
       },
       {
         "NSPrivacyAccessedAPIType": "NSPrivacyAccessedAPICategorySystemBootTime",
         "NSPrivacyAccessedAPITypeReasons": ["35F9.1"]
       },
       {
         "NSPrivacyAccessedAPIType": "NSPrivacyAccessedAPICategoryFileTimestamp",
         "NSPrivacyAccessedAPITypeReasons": ["C617.1"]
       }
     ]
   }
   ```

   然后将其添加到您的 `app.config.ts` 中

   ```ts title='app.config.ts'
   import applePrivacyManifest from './apple-privacy-manifest.json';
   export default ({ config }: ConfigContext): ExpoConfig => ({
     ...config,
     // rest of the config
     ios: {
       // rest of ios config
       privacyManifests: applePrivacyManifest,
     },
   });
   ```

   阅读更多关于 [Apple 隐私清单和 Sentry](https://docs.sentry.io/platforms/react-native/data-management/apple-privacy-manifest/)

10. 现在您已准备好测试 Sentry 集成。按照以下步骤确保错误正在正确报告：

    1. 为您的项目运行预构建命令。
    2. 在模拟器或物理设备上启动应用。
    3. 使用以下代码片段在您的应用中添加触发错误的按钮：

    ```tsx
    import React from 'react';
    import { View, Button } from 'react-native';
    import * as Sentry from '@sentry/react-native';

    const SentryTestComponent = () => {
      const throwJSError = () => {
        throw new Error('Test JavaScript Error for Sentry');
      };

      const triggerNativeError = () => {
        Sentry.nativeCrash();
      };

      return (
        <View>
          <Button title="Trigger JS Error" onPress={throwJSError} />
          <Button title="Trigger Native Error" onPress={triggerNativeError} />
        </View>
      );
    };

    export default SentryTestComponent;
    ```

    4. 在您的应用中实现此组件并与按钮进行交互。
    5. 检查您的 Sentry 仪表板以验证错误是否正在正确报告（确保等待片刻让错误出现）。

    记住，在将应用发布到生产环境之前，请移除或禁用这些测试按钮。

</Steps>

## 更多资源

- [Expo Sentry](https://docs.expo.dev/guides/using-sentry/)
- [Sentry 文档](https://docs.sentry.io/platforms/react-native/manual-setup/expo/)
